<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Send a Tip - TinyRedirect</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div class="container">
    <h1>Send a Tip</h1>

    <button id="connectBtn">Connect Wallet</button>
    <p id="walletStatus">Not connected</p>

    <p><strong>To:</strong> <span id="recipient"></span></p>
    <p><strong>Your Address:</strong> <span id="senderAddress">-</span></p>

    <input type="number" id="amount" placeholder="Amount in ETH" />
    <textarea id="tipMessage" rows="3" placeholder="Write a message for the recipient..."></textarea>
    <button id="sendTipBtn" disabled>Send Tip</button>

    <p id="status"></p>
  </div>

  <script>
    const connectBtn = document.getElementById("connectBtn");
    const sendTipBtn = document.getElementById("sendTipBtn");
    const walletStatus = document.getElementById("walletStatus");
    const senderAddressDisplay = document.getElementById("senderAddress");
    const recipientSpan = document.getElementById("recipient");
    const statusText = document.getElementById("status");

    let signer = null;
    let senderAddress = "";
    let recipientKey = "";
    let recipientAddress = "";

    // Get recipient from URL
    const urlParams = new URLSearchParams(window.location.search);
    recipientKey = urlParams.get("to");

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyB0QtZ8pHEVH-D2VNko9nW-LRSP0Btv2dg",
      authDomain: "tinytip-856d8.firebaseapp.com",
      databaseURL: "https://tinytip-856d8-default-rtdb.firebaseio.com",
      projectId: "tinytip-856d8",
      storageBucket: "tinytip-856d8.appspot.com",
      messagingSenderId: "348256301193",
      appId: "1:348256301193:web:a8f24524db1142e17f9658"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Resolve recipient address
    async function resolveRecipient() {
      if (!recipientKey) {
        statusText.textContent = "No recipient found in URL.";
        throw new Error("No recipient key");
      }

      if (recipientKey.startsWith("0x")) {
        recipientSpan.textContent = recipientKey;
        recipientAddress = recipientKey;
      } else {
        const snapshot = await db.ref("redirects/" + recipientKey.toLowerCase()).once("value");
        const data = snapshot.val();
        if (data && data.address) {
          recipientSpan.textContent = `${data.nickname || recipientKey} (${data.address})`;
          recipientAddress = data.address;
        } else {
          statusText.textContent = "Error: Unknown recipient.";
          throw new Error("Recipient not found in Firebase");
        }
      }
    }

    // Connect Wallet
    connectBtn.onclick = async () => {
      if (typeof window.ethereum === "undefined") {
        alert("Please install MetaMask.");
        return;
      }

      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        senderAddress = await signer.getAddress();
        walletStatus.textContent = "Connected";
        senderAddressDisplay.textContent = senderAddress;
        sendTipBtn.disabled = false;
      } catch (err) {
        console.error(err);
        walletStatus.textContent = "Connection failed.";
      }
    };

    // Handle send tip
    sendTipBtn.onclick = async () => {
      const amount = document.getElementById("amount").value;
      const message = document.getElementById("tipMessage").value;

      if (!signer || !recipientAddress || !amount) {
        alert("Make sure you're connected and have entered a valid amount.");
        return;
      }

      try {
        const tx = await signer.sendTransaction({
          to: recipientAddress,
          value: ethers.utils.parseEther(amount)
        });

        statusText.textContent = "Transaction sent! Waiting for confirmation...";
        await tx.wait();

        // Save tip message to Firebase
        const tipsRef = db.ref("tips/" + recipientKey.toLowerCase());
        await tipsRef.push({
          from: senderAddress,
          amount,
          message,
          timestamp: Date.now()
        });

        statusText.textContent = "Tip sent successfully!";
      } catch (err) {
        console.error(err);
        statusText.textContent = "Error: " + err.message;
      }
    };

    // Start
    resolveRecipient();
  </script>
</body>
</html>
