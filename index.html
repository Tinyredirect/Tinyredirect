<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TinyRedirect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="qrcode.min.js"></script>
</head>
<body>
  <div class="wrapper">
    <header>
      <img src="avatar.svg" alt="Avatar" class="avatar">
      <button id="connectBtn">Connect Wallet</button>
    </header>

    <main>
      <h1>Your Tip Link</h1>
      <code id="walletAddress"></code>
      <input type="text" id="tipLink" readonly />
      <button id="copyBtn">Copy Link</button>
      <div id="qrcode"></div>

      <label for="nickname">Your Nickname</label>
      <input type="text" id="nickname" placeholder="e.g. Anonymous Owl" required />

      <label for="tipMessage">Tip Message</label>
      <textarea id="tipMessage" rows="3" placeholder="Write a short message to display..."></textarea>

      <button id="saveBtn">Save Tip</button>
    </main>

    <footer>
      <a href="https://x.com/yourhandle" target="_blank">X (Twitter)</a>
    </footer>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB0QtZ8pHEVH-D2VNko9nW-LRSP0Btv2dg",
      authDomain: "tinytip-856d8.firebaseapp.com",
      databaseURL: "https://tinytip-856d8-default-rtdb.firebaseio.com",
      projectId: "tinytip-856d8",
      storageBucket: "tinytip-856d8.appspot.com",
      messagingSenderId: "348256301193",
      appId: "1:348256301193:web:a8f24524db1142e17f9658",
      measurementId: "G-2WCQL5MHHN"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentWalletAddress = "";

    document.getElementById("connectBtn").addEventListener("click", async () => {
      if (typeof window.ethereum !== "undefined") {
        try {
          const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
          currentWalletAddress = accounts[0];
          document.getElementById("walletAddress").textContent = currentWalletAddress;

          // Store wallet address to Firebase
          await db.ref("wallets/" + currentWalletAddress).set({
            address: currentWalletAddress,
          });

          const userTipLink = `https://tinyredirect.com/tip/${currentWalletAddress}`;
          document.getElementById("tipLink").value = userTipLink;

          // Generate QR code
          new QRCode(document.getElementById("qrcode"), userTipLink);
        } catch (error) {
          console.error(error);
        }
      } else {
        alert("Please install MetaMask!");
      }
    });

    document.getElementById("copyBtn").addEventListener("click", () => {
      const tipLink = document.getElementById("tipLink");
      tipLink.select();
      document.execCommand("copy");
      alert("Link copied to clipboard!");
    });

    document.getElementById("saveBtn").addEventListener("click", async () => {
      const nickname = document.getElementById("nickname").value.trim();
      const tipMessage = document.getElementById("tipMessage").value.trim();

      if (!nickname || !currentWalletAddress) {
        alert("Nickname and wallet address are required.");
        return;
      }

      // Save the nickname and tip message to Firebase
      await db.ref("redirects/" + nickname.toLowerCase()).set({
        address: currentWalletAddress,
        message: tipMessage,
        nickname: nickname,
      });

      alert("Tip saved successfully! Your link is ready.");
    });
  </script>
</body>
</html>
